import { ElementHandle } from 'playwright'
import { allBrowsersRenderTheSame, setup } from '.'
import { assert } from '../src/Component.utils'

const replayPointerEvents = async (
  handle: ElementHandle<HTMLElement>,
  events: number[][],
  options?: { button?: 'left' | 'middle' | 'right'; clickCount?: number }
) => {
  const boundingBox = await handle.boundingBox()
  assert(!!boundingBox)
  const { x, y } = boundingBox
  const startEvent = events[0]
  const moveEvents = events.slice(1)

  await page.mouse.move(startEvent[0] + x, startEvent[1] + y)
  await page.mouse.down(options)

  await Promise.all(
    moveEvents.map(([dx, dy]) => page.mouse.move(x + dx, y + dy))
  )
  await page.mouse.up()
}

describe('pointer events', () => {
  test('direct manipulation (horizontal)', async () => {
    const slider = await setup({ step: '0.1' })

    await replayPointerEvents(slider, [
      [95.62469482421875, 15.0103759765625],
      [95.85549926757812, 15.0103759765625],
      [96.67648315429688, 15.0103759765625],
      [97.49530029296875, 15.0103759765625],
      [98.06697082519531, 14.72454833984375],
      [98.63864135742188, 14.438720703125],
      [99.21031188964844, 14.438720703125],
      [99.781982421875, 14.15289306640625],
      [100.35365295410156, 13.8670654296875],
      [101.29440307617188, 13.8670654296875],
      [101.86607360839844, 13.58123779296875],
      [102.80682373046875, 13.58123779296875],
      [103.74757385253906, 13.267654418945312],
      [105.11129760742188, 13.267654418945312],
      [106.47674560546875, 12.926300048828125],
      [108.32254028320312, 12.926300048828125],
      [109.68798828125, 12.584945678710938],
      [111.53378295898438, 12.584945678710938],
      [113.37957763671875, 12.215789794921875],
      [115.22537231445312, 12.215789794921875],
      [117.04849243164062, 11.851165771484375],
      [118.894287109375, 11.851165771484375],
      [120.25973510742188, 11.851165771484375],
      [121.62518310546875, 11.509811401367188],
      [122.99063110351562, 11.509811401367188],
      [124.3560791015625, 11.509811401367188],
      [125.7213134765625, 11.509811401367188],
      [127.08676147460938, 11.509811401367188],
      [128.4488525390625, 11.509811401367188],
      [129.81430053710938, 11.509811401367188],
      [131.17974853515625, 11.509811401367188],
      [132.12049865722656, 11.509811401367188],
      [133.96629333496094, 11.509811401367188],
      [135.3317413330078, 11.509811401367188],
      [136.6971893310547, 11.509811401367188],
      [138.0626220703125, 11.509811401367188],
      [139.4281005859375, 11.509811401367188],
      [140.79351806640625, 11.509811401367188],
      [141.73428344726562, 11.509811401367188],
      [143.0997314453125, 11.509811401367188],
      [144.46517944335938, 11.509811401367188],
      [145.40594482421875, 11.509811401367188],
      [146.7713623046875, 11.509811401367188],
      [148.1368408203125, 11.509811401367188],
      [149.98260498046875, 11.509811401367188],
      [151.33929443359375, 11.509811401367188],
      [154.16497802734375, 11.509811401367188],
      [155.53042602539062, 11.509811401367188],
      [156.8958740234375, 11.509811401367188],
      [157.83660888671875, 11.509811401367188],
      [158.77737426757812, 11.509811401367188],
      [159.7181396484375, 11.509811401367188],
      [160.65887451171875, 11.509811401367188],
      [161.599609375, 11.509811401367188],
      [162.54037475585938, 11.509811401367188],
      [163.112060546875, 11.509811401367188],
      [163.6837158203125, 11.795639038085938],
      [164.25537109375, 11.795639038085938],
      [164.51348876953125, 12.053741455078125],
      [165.08514404296875, 12.053741455078125],
      [165.34326171875, 12.053741455078125],
      [165.60137939453125, 12.311843872070312],
      [165.85946655273438, 12.311843872070312],
      [166.1175537109375, 12.311843872070312],
      [166.36209106445312, 12.556365966796875],
      [166.36209106445312, 12.79638671875],
      [166.36209106445312, 13.036300659179688],
      [166.5972900390625, 13.036300659179688],
      [166.365966796875, 13.036300659179688],
      [166.10787963867188, 13.036300659179688],
      [165.53619384765625, 13.036300659179688],
      [164.595458984375, 13.036300659179688],
      [163.65472412109375, 13.036300659179688],
      [162.28924560546875, 13.036300659179688],
      [160.923828125, 13.036300659179688],
      [159.558349609375, 13.036300659179688],
      [157.71258544921875, 13.036300659179688],
      [155.3306884765625, 13.036300659179688],
      [153.48486328125, 13.036300659179688],
      [151.10296630859375, 13.036300659179688],
      [149.2572021484375, 13.036300659179688],
      [145.65826416015625, 13.036300659179688],
      [142.68447875976562, 13.036300659179688],
      [139.06292724609375, 13.036300659179688],
      [134.7376251220703, 13.036300659179688],
      [129.6965789794922, 13.036300659179688],
      [123.79571533203125, 13.572738647460938],
      [113.010009765625, 14.246841430664062],
      [103.28359985351562, 14.895263671875],
      [92.45988464355469, 16.248214721679688],
      [86.55902099609375, 17.321090698242188],
      [76.83261108398438, 18.617935180664062],
      [67.106201171875, 20.563217163085938],
      [57.379791259765625, 21.860061645507812],
      [49.678741455078125, 23.044830322265625],
      [41.977691650390625, 24.821990966796875],
      [39.595794677734375, 25.218963623046875],
      [34.51075744628906, 25.727462768554688],
      [30.889190673828125, 26.180145263671875],
      [27.915390014648438, 26.604965209960938],
      [26.069595336914062, 26.97412109375],
      [24.704147338867188, 27.315475463867188],
      [23.338699340820312, 27.315475463867188],
      [22.39794921875, 27.315475463867188],
      [21.826278686523438, 27.315475463867188],
      [21.56817626953125, 27.315475463867188],
      [20.996627807617188, 27.315475463867188],
      [20.738525390625, 27.315475463867188],
      [20.480422973632812, 27.315475463867188],
      [20.235809326171875, 27.315475463867188],
      [19.977706909179688, 27.315475463867188],
      [19.73272705078125, 27.315475463867188],
      [19.96490478515625, 27.315475463867188],
      [20.536575317382812, 27.315475463867188],
      [21.108245849609375, 27.315475463867188],
      [21.679916381835938, 27.315475463867188],
      [22.25128173828125, 27.029800415039062],
      [22.822952270507812, 27.029800415039062],
      [23.394622802734375, 26.743972778320312],
      [24.335372924804688, 26.430389404296875],
      [25.276123046875, 26.116806030273438],
      [25.847793579101562, 25.545135498046875],
      [26.78570556640625, 24.91986083984375],
      [27.726455688476562, 24.606277465820312],
      [28.298126220703125, 24.03460693359375],
      [29.238876342773438, 23.721023559570312],
      [29.810546875, 23.14935302734375],
      [30.068649291992188, 22.891250610351562],
      [30.64031982421875, 22.891250610351562],
      [30.898422241210938, 22.633148193359375],
      [31.156524658203125, 22.633148193359375],
      [31.414627075195312, 22.633148193359375],
      [31.6727294921875, 22.633148193359375],
      [32.86259460449219, 22.633148193359375],
      [37.18788146972656, 22.152572631835938],
      [42.27008056640625, 22.152572631835938],
      [49.04292297363281, 21.023773193359375],
      [57.72846984863281, 19.782989501953125],
      [67.45487976074219, 18.48614501953125],
      [78.27859497070312, 17.809677124023438],
      [89.10231018066406, 16.45672607421875],
      [99.926025390625, 15.780258178710938],
      [105.01106262207031, 15.780258178710938],
      [114.73747253417969, 15.1318359375],
      [122.43852233886719, 15.1318359375],
      [128.2451934814453, 15.1318359375],
      [134.14605712890625, 15.1318359375],
      [135.99185180664062, 15.1318359375],
      [143.69290161132812, 15.1318359375],
      [145.058349609375, 15.1318359375],
      [148.03216552734375, 15.1318359375],
      [150.4140625, 15.1318359375],
      [152.25982666015625, 15.500991821289062],
      [153.62530517578125, 15.500991821289062],
      [154.5660400390625, 15.8145751953125],
      [155.1376953125, 15.8145751953125],
      [155.70709228515625, 15.8145751953125],
      [156.27877807617188, 15.8145751953125],
      [156.536865234375, 15.8145751953125],
      [156.79498291015625, 15.8145751953125],
      [157.03985595703125, 15.8145751953125],
      [156.80810546875, 15.8145751953125],
      [156.5704345703125, 15.8145751953125],
      [156.31234741210938, 15.8145751953125],
      [155.74481201171875, 15.8145751953125],
      [155.17315673828125, 15.8145751953125],
      [154.232421875, 15.8145751953125],
      [153.29165649414062, 15.8145751953125],
      [151.44586181640625, 15.8145751953125],
      [149.06396484375, 15.8145751953125],
      [146.68206787109375, 15.8145751953125],
      [143.070556640625, 15.8145751953125],
      [136.29769897460938, 15.8145751953125],
      [132.67613220214844, 15.8145751953125],
      [125.90328979492188, 15.8145751953125],
      [120.85371398925781, 15.8145751953125],
      [114.95285034179688, 15.8145751953125],
      [109.92279052734375, 15.311569213867188],
      [107.5408935546875, 15.311569213867188],
      [99.83984375, 14.719192504882812],
      [95.51455688476562, 14.719192504882812],
      [91.89299011230469, 14.719192504882812],
      [90.04719543457031, 14.719192504882812],
      [84.962158203125, 14.719192504882812],
      [83.11636352539062, 14.719192504882812],
      [80.73446655273438, 14.719192504882812],
      [78.35256958007812, 14.719192504882812],
      [75.97067260742188, 14.719192504882812],
      [74.1248779296875, 14.719192504882812],
      [72.27908325195312, 14.719192504882812],
      [70.92205810546875, 14.719192504882812],
      [69.55661010742188, 14.719192504882812],
      [68.61585998535156, 14.719192504882812],
      [68.044189453125, 14.719192504882812],
      [67.47624206542969, 14.719192504882812],
      [67.2181396484375, 14.719192504882812],
      [67.2181396484375, 14.479248046875],
      [67.2181396484375, 14.234588623046875],
      [67.73649597167969, 13.975418090820312],
      [68.67724609375, 13.975418090820312],
      [69.61799621582031, 13.975418090820312],
      [70.55836486816406, 13.975418090820312],
      [71.92381286621094, 13.634063720703125],
      [72.86456298828125, 13.634063720703125],
      [73.80531311035156, 13.320480346679688],
      [75.17076110839844, 13.320480346679688],
      [76.11151123046875, 13.00689697265625],
      [77.05226135253906, 13.00689697265625],
      [77.99301147460938, 12.693313598632812],
      [79.35845947265625, 12.351959228515625],
      [80.72390747070312, 12.010604858398438],
      [83.10580444335938, 11.613632202148438],
      [84.95159912109375, 11.244476318359375],
      [87.92539978027344, 11.244476318359375],
      [91.54696655273438, 11.244476318359375],
      [95.16853332519531, 11.244476318359375],
      [100.25357055664062, 11.244476318359375],
      [104.578857421875, 11.244476318359375],
      [109.66389465332031, 11.244476318359375],
      [113.98918151855469, 11.244476318359375],
      [118.31446838378906, 11.244476318359375],
      [120.15238952636719, 11.244476318359375],
      [123.77395629882812, 11.244476318359375],
      [126.74775695800781, 11.244476318359375],
      [129.12965393066406, 11.641448974609375],
      [130.97544860839844, 12.010604858398438],
      [132.8212432861328, 12.3797607421875],
      [134.1866912841797, 12.721115112304688],
      [135.12744140625, 13.034698486328125],
      [136.0681915283203, 13.348281860351562],
      [137.00894165039062, 13.661865234375],
      [137.26702880859375, 13.919967651367188],
      [137.525146484375, 14.178070068359375],
      [137.78326416015625, 14.178070068359375],
      [138.04135131835938, 14.178070068359375],
      [137.55221557617188, 14.178070068359375],
      [135.7064208984375, 14.178070068359375],
      [132.7326202392578, 14.178070068359375],
      [126.83175659179688, 14.178070068359375],
      [119.13070678710938, 14.178070068359375],
      [109.404296875, 14.178070068359375],
      [97.42678833007812, 14.178070068359375],
      [84.2388916015625, 14.178070068359375],
      [77.55853271484375, 14.734756469726562],
      [73.23324584960938, 14.734756469726562],
      [65.58370971679688, 15.32318115234375],
      [59.68284606933594, 15.32318115234375],
      [56.069366455078125, 15.774856567382812],
      [53.687469482421875, 15.774856567382812],
      [52.322021484375, 15.774856567382812],
      [51.75035095214844, 15.774856567382812],
      [53.0828857421875, 15.774856567382812],
      [55.46478271484375, 15.774856567382812],
      [57.8466796875, 15.774856567382812],
      [63.74754333496094, 15.774856567382812],
      [69.64840698242188, 15.774856567382812],
      [76.42124938964844, 16.339248657226562],
      [86.14765930175781, 16.9876708984375],
      [91.23269653320312, 17.496170043945312],
      [99.91824340820312, 18.736953735351562],
      [107.61929321289062, 19.329330444335938],
      [110.57284545898438, 19.751266479492188],
      [115.65788269042969, 20.259765625],
      [120.742919921875, 20.768264770507812],
      [123.71672058105469, 21.193084716796875],
      [126.69052124023438, 21.617904663085938],
      [128.05596923828125, 21.617904663085938],
      [129.42141723632812, 21.617904663085938],
      [129.9930877685547, 21.617904663085938],
      [130.25119018554688, 21.617904663085938],
      [130.50927734375, 21.617904663085938],
      [130.50927734375, 21.377914428710938],
      [129.14382934570312, 20.6951904296875],
      [126.17002868652344, 19.845535278320312],
      [119.39718627929688, 19.281143188476562],
      [110.71163940429688, 18.660751342773438],
      [100.9852294921875, 18.660751342773438],
      [89.00772094726562, 18.660751342773438],
      [83.10685729980469, 18.660751342773438],
      [78.78157043457031, 18.660751342773438],
      [72.03636169433594, 18.660751342773438],
      [66.95132446289062, 18.660751342773438],
      [63.32975769042969, 18.660751342773438],
      [60.94786071777344, 18.660751342773438],
      [60.007110595703125, 18.660751342773438],
      [59.43623352050781, 18.660751342773438],
      [59.92570495605469, 18.660751342773438],
      [61.29115295410156, 18.660751342773438],
      [63.67304992675781, 18.660751342773438],
      [66.6468505859375, 18.660751342773438],
      [73.41969299316406, 18.660751342773438],
      [82.10523986816406, 18.660751342773438],
      [91.83164978027344, 18.660751342773438],
      [102.65536499023438, 18.660751342773438],
      [114.63287353515625, 19.365310668945312],
      [120.53373718261719, 19.901748657226562],
      [130.26014709472656, 20.5501708984375],
      [138.9456787109375, 21.170562744140625],
      [141.91949462890625, 21.595382690429688],
      [147.82037353515625, 22.131820678710938],
      [152.9053955078125, 22.131820678710938],
      [156.5269775390625, 22.584503173828125],
      [159.50076293945312, 22.584503173828125],
      [161.3465576171875, 22.584503173828125],
      [163.18487548828125, 22.584503173828125],
      [164.3319091796875, 22.584503173828125],
      [165.27264404296875, 22.584503173828125],
      [165.84432983398438, 22.584503173828125],
      [166.416015625, 22.584503173828125],
      [166.98602294921875, 22.584503173828125],
      [167.244140625, 22.584503173828125],
      [167.5018310546875, 22.584503173828125],
      [167.75994873046875, 22.326400756835938],
      [168.01806640625, 22.326400756835938],
      [168.5897216796875, 22.040573120117188],
      [169.161376953125, 22.040573120117188],
      [169.73306274414062, 22.040573120117188],
      [170.3033447265625, 21.755447387695312],
      [171.24407958984375, 21.755447387695312],
      [171.81573486328125, 21.755447387695312],
      [172.38742065429688, 21.755447387695312],
      [172.9591064453125, 21.469619750976562],
      [173.21719360351562, 21.469619750976562],
      [173.47528076171875, 21.469619750976562],
      [173.7333984375, 21.469619750976562],
      [173.99151611328125, 21.469619750976562],
      [174.24960327148438, 21.469619750976562],
      [174.48480224609375, 21.469619750976562],
      [174.7177734375, 21.469619750976562],
      [174.96255493164062, 21.469619750976562],
      [174.73080444335938, 21.469619750976562],
      [174.47271728515625, 21.469619750976562],
      [174.22811889648438, 21.469619750976562],
      [173.65643310546875, 21.469619750976562],
      [173.3984375, 21.469619750976562],
      [172.8267822265625, 21.469619750976562],
      [171.88604736328125, 21.469619750976562],
      [170.94528198242188, 21.469619750976562],
      [170.0045166015625, 21.469619750976562],
      [168.63909912109375, 21.469619750976562],
      [166.79327392578125, 21.469619750976562],
      [163.81948852539062, 21.469619750976562],
      [160.19793701171875, 21.469619750976562],
      [154.29705810546875, 21.469619750976562],
      [149.97177124023438, 21.469619750976562],
      [144.0709228515625, 21.469619750976562],
      [138.1700439453125, 21.469619750976562],
      [131.39720153808594, 21.469619750976562],
      [123.69615173339844, 22.061996459960938],
      [115.99510192871094, 22.654373168945312],
      [108.31098937988281, 23.245452880859375],
      [100.60993957519531, 23.83782958984375],
      [93.83709716796875, 24.4022216796875],
      [87.06425476074219, 24.96661376953125],
      [81.97921752929688, 24.96661376953125],
      [76.07835388183594, 24.96661376953125],
      [70.99331665039062, 25.475112915039062],
      [65.90827941894531, 25.475112915039062],
      [61.58299255371094, 25.475112915039062],
      [57.25770568847656, 25.475112915039062],
      [55.41191101074219, 25.475112915039062],
      [51.796112060546875, 25.475112915039062],
      [48.82231140136719, 25.475112915039062],
      [46.44587707519531, 25.475112915039062],
      [44.60008239746094, 25.475112915039062],
      [43.659332275390625, 25.475112915039062],
      [42.71858215332031, 25.475112915039062],
      [41.77783203125, 25.475112915039062],
      [41.51972961425781, 25.475112915039062],
      [41.26165771484375, 25.475112915039062],
      [41.00355529785156, 25.475112915039062],
      [40.74555969238281, 25.475112915039062],
      [40.50553894042969, 25.475112915039062],
      [40.50553894042969, 25.239990234375],
      [40.50553894042969, 24.995193481445312],
      [40.50553894042969, 24.75054931640625],
      [40.50553894042969, 24.492446899414062],
      [40.50553894042969, 24.234481811523438],
      [40.50553894042969, 23.989761352539062],
      [40.50553894042969, 23.755783081054688],
      [40.50553894042969, 23.521270751953125],
    ])

    expect(await slider.getAttribute('value')).toBe('21')

    expect(await slider.screenshot()).toMatchImageSnapshot(
      allBrowsersRenderTheSame
    )
  })

  test('pixel position is 1:1 with value', async () => {
    const slider = await setup({ value: '0', min: '0', max: '100', step: '0.01' })
    const boundingBox = await slider.boundingBox()
    assert(!!boundingBox)
    const { x, y, width } = boundingBox

    await page.mouse.move(x, 1 + y)
    await page.mouse.down()

    page.mouse.move(x + (width / 2), 1 + y)
    await page.mouse.up()

    expect(await slider.getAttribute('value')).toBe('50')
  })

  // we're ignoring Webkit here because a right-click causes the browser to lose focus
  // and then can't callback to Playwright and the test hangs.
  test.jestPlaywrightSkip({ browsers: ['webkit'] }, 'right-click is ignored', async () => {
    const slider = await setup({ value: '0', step: '0.1' })
    const boundingBox = await slider.boundingBox()
    assert(!!boundingBox)
    const { x, y, width } = boundingBox

    await page.click('afix-range-slider', { button: 'right' })

    await page.mouse.move(x + width, y)
    await page.mouse.up()

    expect(await slider.getAttribute('value')).toBe('0')
  })
})
